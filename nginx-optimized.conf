# ğŸš€ Nginx é«˜æ€§èƒ½ä¼˜åŒ–é…ç½® - Dreamle Mining Platform
# é’ˆå¯¹å¸å®‰é’±åŒ…ç­‰ DApp æµè§ˆå™¨ä¼˜åŒ–

server {
    server_name dreamlewebai.com www.dreamlewebai.com;

    # ==================== æ€§èƒ½ä¼˜åŒ–é…ç½® ====================
    
    # 1. å¯ç”¨ HTTP/2ï¼ˆæ›´å¿«çš„å¤šè·¯å¤ç”¨ï¼‰
    listen 443 ssl http2;
    
    # 2. SSL ä¼˜åŒ–ï¼ˆä½¿ç”¨ Let's Encrypt é»˜è®¤é…ç½®ï¼‰
    ssl_certificate /etc/letsencrypt/live/dreamlewebai.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/dreamlewebai.com/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
    
    # 3. Gzip å‹ç¼©é…ç½®ï¼ˆæœ€å¤§åŒ–å‹ç¼©ï¼‰
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 9;  # æå‡åˆ°æœ€é«˜å‹ç¼©çº§åˆ«
    gzip_types 
        text/plain 
        text/css 
        text/xml 
        text/javascript 
        application/json 
        application/javascript 
        application/x-javascript
        application/xml 
        application/xml+rss 
        application/rss+xml 
        font/truetype 
        font/opentype 
        application/vnd.ms-fontobject 
        image/svg+xml
        image/x-icon;
    gzip_min_length 256;  # é™ä½æœ€å°å‹ç¼©å¤§å°
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    
    # 4. Brotli å‹ç¼©ï¼ˆæ¯” Gzip æ›´å¥½ï¼Œå¦‚æœå·²å®‰è£…ï¼‰
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;
    
    # 5. ç¼“å­˜é…ç½® - å®Œå…¨ç¦ç”¨
    # ç¦ç”¨æ–‡ä»¶ç¼“å­˜ï¼ˆç¡®ä¿ç”¨æˆ·æ€»æ˜¯è·å–æœ€æ–°æ–‡ä»¶ï¼‰
    open_file_cache off;
    
    # 6. è¿æ¥ä¼˜åŒ–
    keepalive_timeout 65;
    keepalive_requests 100;
    
    # 7. ç¼“å†²åŒºä¼˜åŒ–
    client_body_buffer_size 128k;
    client_max_body_size 10m;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;
    output_buffers 1 32k;
    postpone_output 1460;
    
    # 8. TCP ä¼˜åŒ–
    tcp_nopush on;
    tcp_nodelay on;
    
    # 9. å®‰å…¨å¤´éƒ¨
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    
    # ==================== è·¯ç”±é…ç½® ====================
    
    # NFT Metadata API - åŠ¨æ€è·¯ç”±
    location ~ ^/api/metadata/(\d+)\.json$ {
        root /root/dreamle-mining;
        try_files $uri @php_metadata;

        # CORS å¤´éƒ¨
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type" always;

        # ç¼“å­˜ metadataï¼ˆ1å°æ—¶ï¼‰
        add_header Cache-Control "public, max-age=3600" always;
    }

    # PHP å¤„ç† metadataï¼ˆå¦‚æœé™æ€æ–‡ä»¶ä¸å­˜åœ¨ï¼‰
    location @php_metadata {
        root /root/dreamle-mining;
        fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /root/dreamle-mining/api/nft-metadata.php;
        include fastcgi_params;

        # CORS å¤´éƒ¨
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Content-Type" always;

        # ç¼“å­˜ metadataï¼ˆ1å°æ—¶ï¼‰
        add_header Cache-Control "public, max-age=3600" always;
    }

    # ä¸»é¡µé¢ - å®Œå…¨ç¦ç”¨ç¼“å­˜
    location / {
        root /root/dreamle-mining;
        index index.html platform.html;
        try_files $uri $uri/ =404;

        # CORS å¤´éƒ¨
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range" always;

        # å®Œå…¨ç¦ç”¨ç¼“å­˜
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        # ç¦ç”¨ ETagï¼ˆé˜²æ­¢æ¡ä»¶è¯·æ±‚ç¼“å­˜ï¼‰
        etag off;
        if_modified_since off;
    }

    # JS/CSS æ–‡ä»¶ - å®Œå…¨ç¦ç”¨ç¼“å­˜
    location ~* \.(js|css)$ {
        root /root/dreamle-mining;

        # CORS å¤´éƒ¨
        add_header Access-Control-Allow-Origin * always;

        # å®Œå…¨ç¦ç”¨ç¼“å­˜
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        # ç¦ç”¨ ETag
        etag off;
        if_modified_since off;

        # ä¿ç•™ Gzip å‹ç¼©ä»¥æå‡ä¼ è¾“é€Ÿåº¦
        gzip_static on;
    }

    # å›¾ç‰‡èµ„æº - å®Œå…¨ç¦ç”¨ç¼“å­˜
    location ~* \.(png|jpg|jpeg|gif|ico|svg|webp)$ {
        root /root/dreamle-mining;

        # CORS å¤´éƒ¨
        add_header Access-Control-Allow-Origin * always;

        # å®Œå…¨ç¦ç”¨ç¼“å­˜
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        # ç¦ç”¨ ETag
        etag off;
        if_modified_since off;

        # ä¸è®°å½•å›¾ç‰‡è®¿é—®æ—¥å¿—ï¼ˆä¿æŒæ€§èƒ½ï¼‰
        access_log off;
    }

    # å­—ä½“æ–‡ä»¶ - å®Œå…¨ç¦ç”¨ç¼“å­˜
    location ~* \.(woff|woff2|ttf|otf|eot)$ {
        root /root/dreamle-mining;

        # CORS å¤´éƒ¨
        add_header Access-Control-Allow-Origin * always;

        # å®Œå…¨ç¦ç”¨ç¼“å­˜
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        # ç¦ç”¨ ETag
        etag off;
        if_modified_since off;

        access_log off;
    }

    # JSON é…ç½®æ–‡ä»¶ - å®Œå…¨ç¦ç”¨ç¼“å­˜
    location ~* \.json$ {
        root /root/dreamle-mining;

        # CORS å¤´éƒ¨
        add_header Access-Control-Allow-Origin * always;

        # å®Œå…¨ç¦ç”¨ç¼“å­˜
        add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;

        # ç¦ç”¨ ETag
        etag off;
        if_modified_since off;
    }
    
    # ç¦æ­¢è®¿é—®éšè—æ–‡ä»¶
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # ç¦æ­¢è®¿é—®å¤‡ä»½æ–‡ä»¶
    location ~ ~$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # ==================== æ—¥å¿—é…ç½® ====================
    
    # è®¿é—®æ—¥å¿—ï¼ˆå¯é€‰ï¼šå…³é—­ä»¥æå‡æ€§èƒ½ï¼‰
    access_log /var/log/nginx/dreamle-access.log;
    error_log /var/log/nginx/dreamle-error.log warn;
    
    # å¦‚æœè¦æœ€å¤§åŒ–æ€§èƒ½ï¼Œå¯ä»¥å…³é—­è®¿é—®æ—¥å¿—ï¼š
    # access_log off;
}

# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name dreamlewebai.com www.dreamlewebai.com;
    
    # å¼ºåˆ¶ HTTPS
    return 301 https://$host$request_uri;
}

