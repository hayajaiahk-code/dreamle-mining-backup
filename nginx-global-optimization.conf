# ğŸš€ Nginx å…¨å±€æ€§èƒ½ä¼˜åŒ–é…ç½®
# æ·»åŠ åˆ° /etc/nginx/nginx.conf çš„ http å—ä¸­

# ==================== å·¥ä½œè¿›ç¨‹ä¼˜åŒ– ====================

# å·¥ä½œè¿›ç¨‹æ•°ï¼ˆè®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°ï¼‰
worker_processes auto;

# æ¯ä¸ªå·¥ä½œè¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°
events {
    worker_connections 4096;  # ä»é»˜è®¤ 768 æå‡åˆ° 4096
    use epoll;  # Linux ä¸‹ä½¿ç”¨ epollï¼ˆé«˜æ€§èƒ½äº‹ä»¶æ¨¡å‹ï¼‰
    multi_accept on;  # å…è®¸ä¸€æ¬¡æ¥å—å¤šä¸ªè¿æ¥
}

# ==================== HTTP å…¨å±€ä¼˜åŒ– ====================

http {
    # åŸºç¡€è®¾ç½®
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # ==================== æ€§èƒ½ä¼˜åŒ– ====================
    
    # 1. æ–‡ä»¶ä¼ è¾“ä¼˜åŒ–
    sendfile on;  # å¯ç”¨é«˜æ•ˆæ–‡ä»¶ä¼ è¾“
    sendfile_max_chunk 512k;  # æ¯æ¬¡å‘é€çš„æœ€å¤§æ•°æ®å—
    tcp_nopush on;  # ä¼˜åŒ–æ•°æ®åŒ…å‘é€
    tcp_nodelay on;  # ç¦ç”¨ Nagle ç®—æ³•ï¼Œå‡å°‘å»¶è¿Ÿ
    
    # 2. è¿æ¥ä¼˜åŒ–
    keepalive_timeout 65;  # ä¿æŒè¿æ¥æ—¶é—´
    keepalive_requests 100;  # æ¯ä¸ªè¿æ¥çš„æœ€å¤§è¯·æ±‚æ•°
    reset_timedout_connection on;  # é‡ç½®è¶…æ—¶è¿æ¥
    
    # 3. å®¢æˆ·ç«¯è¯·æ±‚ä¼˜åŒ–
    client_body_timeout 12;  # å®¢æˆ·ç«¯è¯·æ±‚ä½“è¶…æ—¶
    client_header_timeout 12;  # å®¢æˆ·ç«¯è¯·æ±‚å¤´è¶…æ—¶
    send_timeout 10;  # å‘é€è¶…æ—¶
    
    # 4. ç¼“å†²åŒºä¼˜åŒ–
    client_body_buffer_size 128k;  # è¯·æ±‚ä½“ç¼“å†²åŒº
    client_max_body_size 10m;  # æœ€å¤§è¯·æ±‚ä½“å¤§å°
    client_header_buffer_size 1k;  # è¯·æ±‚å¤´ç¼“å†²åŒº
    large_client_header_buffers 4 8k;  # å¤§è¯·æ±‚å¤´ç¼“å†²åŒº
    
    # 5. æ–‡ä»¶ç¼“å­˜ä¼˜åŒ–
    open_file_cache max=10000 inactive=30s;  # æ‰“å¼€æ–‡ä»¶ç¼“å­˜
    open_file_cache_valid 60s;  # ç¼“å­˜æœ‰æ•ˆæœŸ
    open_file_cache_min_uses 2;  # æœ€å°ä½¿ç”¨æ¬¡æ•°
    open_file_cache_errors on;  # ç¼“å­˜é”™è¯¯ä¿¡æ¯
    
    # 6. FastCGI ç¼“å­˜ï¼ˆå¦‚æœä½¿ç”¨ PHPï¼‰
    # fastcgi_cache_path /var/cache/nginx levels=1:2 keys_zone=FASTCGI:100m inactive=60m;
    # fastcgi_cache_key "$scheme$request_method$host$request_uri";
    # fastcgi_cache_use_stale error timeout invalid_header http_500;
    # fastcgi_ignore_headers Cache-Control Expires Set-Cookie;
    
    # 7. Gzip å‹ç¼©ï¼ˆå…¨å±€ï¼‰
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 9;  # æœ€é«˜å‹ç¼©çº§åˆ«
    gzip_types 
        text/plain 
        text/css 
        text/xml 
        text/javascript 
        application/json 
        application/javascript 
        application/x-javascript
        application/xml 
        application/xml+rss 
        application/rss+xml 
        font/truetype 
        font/opentype 
        application/vnd.ms-fontobject 
        image/svg+xml
        image/x-icon;
    gzip_min_length 256;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_disable "msie6";
    
    # 8. æ—¥å¿—ä¼˜åŒ–
    access_log /var/log/nginx/access.log combined buffer=32k flush=5s;
    error_log /var/log/nginx/error.log warn;
    
    # å¦‚æœè¦æœ€å¤§åŒ–æ€§èƒ½ï¼Œå¯ä»¥å…³é—­è®¿é—®æ—¥å¿—ï¼š
    # access_log off;
    
    # 9. é™æµé…ç½®ï¼ˆé˜²æ­¢ DDoSï¼‰
    limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    
    # 10. ä»£ç†ç¼“å†²åŒºä¼˜åŒ–
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;
    
    # 11. éšè— Nginx ç‰ˆæœ¬å·ï¼ˆå®‰å…¨ï¼‰
    server_tokens off;
    
    # 12. å­—ç¬¦é›†
    charset utf-8;
    
    # ==================== åŒ…å«ç«™ç‚¹é…ç½® ====================
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}

