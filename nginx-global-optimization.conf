# 🚀 Nginx 全局性能优化配置
# 添加到 /etc/nginx/nginx.conf 的 http 块中

# ==================== 工作进程优化 ====================

# 工作进程数（设置为 CPU 核心数）
worker_processes auto;

# 每个工作进程的最大连接数
events {
    worker_connections 4096;  # 从默认 768 提升到 4096
    use epoll;  # Linux 下使用 epoll（高性能事件模型）
    multi_accept on;  # 允许一次接受多个连接
}

# ==================== HTTP 全局优化 ====================

http {
    # 基础设置
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    # ==================== 性能优化 ====================
    
    # 1. 文件传输优化
    sendfile on;  # 启用高效文件传输
    sendfile_max_chunk 512k;  # 每次发送的最大数据块
    tcp_nopush on;  # 优化数据包发送
    tcp_nodelay on;  # 禁用 Nagle 算法，减少延迟
    
    # 2. 连接优化
    keepalive_timeout 65;  # 保持连接时间
    keepalive_requests 100;  # 每个连接的最大请求数
    reset_timedout_connection on;  # 重置超时连接
    
    # 3. 客户端请求优化
    client_body_timeout 12;  # 客户端请求体超时
    client_header_timeout 12;  # 客户端请求头超时
    send_timeout 10;  # 发送超时
    
    # 4. 缓冲区优化
    client_body_buffer_size 128k;  # 请求体缓冲区
    client_max_body_size 10m;  # 最大请求体大小
    client_header_buffer_size 1k;  # 请求头缓冲区
    large_client_header_buffers 4 8k;  # 大请求头缓冲区
    
    # 5. 文件缓存优化
    open_file_cache max=10000 inactive=30s;  # 打开文件缓存
    open_file_cache_valid 60s;  # 缓存有效期
    open_file_cache_min_uses 2;  # 最小使用次数
    open_file_cache_errors on;  # 缓存错误信息
    
    # 6. FastCGI 缓存（如果使用 PHP）
    # fastcgi_cache_path /var/cache/nginx levels=1:2 keys_zone=FASTCGI:100m inactive=60m;
    # fastcgi_cache_key "$scheme$request_method$host$request_uri";
    # fastcgi_cache_use_stale error timeout invalid_header http_500;
    # fastcgi_ignore_headers Cache-Control Expires Set-Cookie;
    
    # 7. Gzip 压缩（全局）
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 9;  # 最高压缩级别
    gzip_types 
        text/plain 
        text/css 
        text/xml 
        text/javascript 
        application/json 
        application/javascript 
        application/x-javascript
        application/xml 
        application/xml+rss 
        application/rss+xml 
        font/truetype 
        font/opentype 
        application/vnd.ms-fontobject 
        image/svg+xml
        image/x-icon;
    gzip_min_length 256;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_disable "msie6";
    
    # 8. 日志优化
    access_log /var/log/nginx/access.log combined buffer=32k flush=5s;
    error_log /var/log/nginx/error.log warn;
    
    # 如果要最大化性能，可以关闭访问日志：
    # access_log off;
    
    # 9. 限流配置（防止 DDoS）
    limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    
    # 10. 代理缓冲区优化
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;
    
    # 11. 隐藏 Nginx 版本号（安全）
    server_tokens off;
    
    # 12. 字符集
    charset utf-8;
    
    # ==================== 包含站点配置 ====================
    include /etc/nginx/conf.d/*.conf;
    include /etc/nginx/sites-enabled/*;
}

