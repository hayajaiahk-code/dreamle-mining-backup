# ğŸ—‘ï¸ API æœåŠ¡å™¨åˆ é™¤æ–¹æ¡ˆ

**å‘ç°**: æœåŠ¡å™¨ä¸Šæœ‰ä¸€ä¸ª Python Flask API æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ  
**é—®é¢˜**: è¿™ä¸ª API æœåŠ¡å™¨æ˜¯**å¤šä½™çš„**ï¼Œä¼šå¢åŠ å»¶è¿Ÿå’Œå¤æ‚åº¦  
**å»ºè®®**: âœ… **åˆ é™¤ API æœåŠ¡å™¨ï¼Œä½¿ç”¨ç›´è¿ RPC**

---

## ğŸ” å‘ç°çš„ API ç»„ä»¶

### 1. Python API æœåŠ¡å™¨

**æ–‡ä»¶**: `api-server-v2.py`  
**çŠ¶æ€**: âœ… æ­£åœ¨è¿è¡Œï¼ˆPID: 20774ï¼‰  
**ç«¯å£**: 3000  
**ç”¨é€”**: æä¾›åˆçº¦æ•°æ®æŸ¥è¯¢å’Œäº¤æ˜“å‡†å¤‡

```python
# api-server-v2.py
from flask import Flask
app = Flask(__name__)

# è¿æ¥ BSC RPC
BSC_RPC_URL = 'https://lb.drpc.org/bsc/...'
w3 = Web3(Web3.HTTPProvider(BSC_RPC_URL))

# æä¾› API ç«¯ç‚¹
@app.route('/api/health')
@app.route('/api/transaction/prepare')
...
```

---

### 2. Nginx ä»£ç†é…ç½®

**æ–‡ä»¶**: `/etc/nginx/sites-available/dreamle-mining`  
**é…ç½®**:
```nginx
location /api/ {
    proxy_pass http://127.0.0.1:3000/api/;
}
```

---

### 3. å‰ç«¯ API é€‚é…å™¨

| æ–‡ä»¶ | ç”¨é€” | çŠ¶æ€ |
|------|------|------|
| `js/api-purchase-adapter.js` | è´­ä¹°çŸ¿æœº API | âœ… å·²åŠ è½½ |
| `js/admin-api-adapter.js` | ç®¡ç†å‘˜åŠŸèƒ½ API | âœ… å·²åŠ è½½ |
| `generated/auto-generated-adapter.js` | è‡ªåŠ¨ç”Ÿæˆçš„ API | âœ… å·²åŠ è½½ |

**é—®é¢˜**: è¿™äº›æ–‡ä»¶ä½¿ç”¨ `http://localhost:3000`ï¼Œç”¨æˆ·æµè§ˆå™¨æ— æ³•è®¿é—®ï¼

---

## âŒ ä¸ºä»€ä¹ˆ API æœåŠ¡å™¨æ˜¯å¤šä½™çš„ï¼Ÿ

### æ•°æ®æµå¯¹æ¯”

#### å½“å‰æ¶æ„ï¼ˆä½¿ç”¨ APIï¼‰

```
ç”¨æˆ·æµè§ˆå™¨
    â†“
è°ƒç”¨ localhost:3000/api/... âŒ å¤±è´¥ï¼
    â†“
ï¼ˆå¦‚æœé€šè¿‡ Nginx ä»£ç†ï¼‰
    â†“
Nginx è½¬å‘åˆ° 127.0.0.1:3000
    â†“
Python API æœåŠ¡å™¨
    â†“
è°ƒç”¨ BSC RPC (drpc.org)
    â†“
è¿”å›æ•°æ®
    â†“
Python å¤„ç†
    â†“
è¿”å›ç»™ Nginx
    â†“
è¿”å›ç»™ç”¨æˆ·

æ€»å»¶è¿Ÿ: 200ms (ç¾å›½æœåŠ¡å™¨) + 69ms (RPC) = 269ms âŒ
```

#### ç›´è¿æ¶æ„ï¼ˆæ¨èï¼‰

```
ç”¨æˆ·æµè§ˆå™¨
    â†“
JavaScript è°ƒç”¨ Web3.js
    â†“
ç›´è¿ BSC RPC (drpc.org)
    â†“
è¿”å›æ•°æ®
    â†“
æ˜¾ç¤ºç»™ç”¨æˆ·

æ€»å»¶è¿Ÿ: 69ms âœ…
```

**æ”¹å–„**: å¿«äº† **200ms** (74% æå‡)

---

## ğŸ” API æœåŠ¡å™¨çš„å®é™…ä½¿ç”¨æƒ…å†µ

### æ£€æŸ¥ API è°ƒç”¨

```bash
# æ£€æŸ¥å‰ç«¯æ˜¯å¦çœŸçš„è°ƒç”¨ API
grep -r "fetch.*api\|axios.*api" --include="*.js" /root/dreamle-mining/js/

# ç»“æœ: 
# - api-purchase-adapter.js: ä½¿ç”¨ localhost:3000 âŒ
# - admin-api-adapter.js: ä½¿ç”¨ localhost:3000 âŒ
# - auto-generated-adapter.js: ä½¿ç”¨ localhost:3000 âŒ
```

### é—®é¢˜

1. âŒ **localhost:3000 æ— æ³•ä»ç”¨æˆ·æµè§ˆå™¨è®¿é—®**
2. âŒ **å³ä½¿é€šè¿‡ Nginx ä»£ç†ï¼Œä¹Ÿä¼šå¢åŠ å»¶è¿Ÿ**
3. âŒ **API æœåŠ¡å™¨æ˜¯å¤šä½™çš„ä¸­é—´å±‚**
4. âŒ **å¢åŠ äº†ç³»ç»Ÿå¤æ‚åº¦å’Œç»´æŠ¤æˆæœ¬**

---

## âœ… åˆ é™¤æ–¹æ¡ˆ

### æ­¥éª¤ 1: åœæ­¢ API æœåŠ¡å™¨

```bash
# æŸ¥æ‰¾è¿›ç¨‹
ps aux | grep api-server-v2.py

# åœæ­¢è¿›ç¨‹
kill 20774

# æˆ–è€…
pkill -f api-server-v2.py
```

---

### æ­¥éª¤ 2: ç¦ç”¨è‡ªåŠ¨å¯åŠ¨

```bash
# æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨å¯åŠ¨é…ç½®
systemctl list-units | grep api-server
crontab -l | grep api-server

# å¦‚æœæœ‰ systemd æœåŠ¡
systemctl stop api-server
systemctl disable api-server

# å¦‚æœæœ‰ cron ä»»åŠ¡
crontab -e  # åˆ é™¤ç›¸å…³è¡Œ
```

---

### æ­¥éª¤ 3: ç§»é™¤ Nginx ä»£ç†é…ç½®

```bash
# ç¼–è¾‘ Nginx é…ç½®
nano /etc/nginx/sites-available/dreamle-mining

# åˆ é™¤æˆ–æ³¨é‡Šè¿™éƒ¨åˆ†:
# location /api/ {
#     proxy_pass http://127.0.0.1:3000/api/;
# }

# é‡å¯ Nginx
systemctl reload nginx
```

---

### æ­¥éª¤ 4: ç§»é™¤å‰ç«¯ API é€‚é…å™¨

```bash
# ä» platform.html ä¸­ç§»é™¤è¿™äº›è¡Œ:
# <script src="js/api-purchase-adapter.js"></script>
# <script src="generated/auto-generated-adapter.js"></script>
# <script src="js/admin-api-adapter.js"></script>
```

---

### æ­¥éª¤ 5: å¤‡ä»½å¹¶åˆ é™¤æ–‡ä»¶

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p /root/dreamle-mining/backup/api-server

# å¤‡ä»½æ–‡ä»¶
mv /root/dreamle-mining/api-server-v2.py /root/dreamle-mining/backup/api-server/
mv /root/dreamle-mining/js/api-purchase-adapter.js /root/dreamle-mining/backup/api-server/
mv /root/dreamle-mining/js/admin-api-adapter.js /root/dreamle-mining/backup/api-server/
mv /root/dreamle-mining/generated/auto-generated-adapter.js /root/dreamle-mining/backup/api-server/

# ç¡®è®¤åˆ é™¤
ls -la /root/dreamle-mining/backup/api-server/
```

---

## ğŸ“Š åˆ é™¤å‰åå¯¹æ¯”

### æ€§èƒ½å¯¹æ¯”

| æ“ä½œ | ä½¿ç”¨ API | ç›´è¿ RPC | æ”¹å–„ |
|------|---------|---------|------|
| æŸ¥è¯¢ä½™é¢ | 269ms | 69ms | 74% â¬†ï¸ |
| è´­ä¹°çŸ¿æœº | 269ms | 69ms | 74% â¬†ï¸ |
| æŸ¥çœ‹çŸ¿æœº | 269ms | 69ms | 74% â¬†ï¸ |
| ç®¡ç†å‘˜æ“ä½œ | 269ms | 69ms | 74% â¬†ï¸ |

---

### æ¶æ„å¯¹æ¯”

| æŒ‡æ ‡ | ä½¿ç”¨ API | ç›´è¿ RPC |
|------|---------|---------|
| **ç»„ä»¶æ•°é‡** | 5 ä¸ª | 2 ä¸ª |
| **ç»´æŠ¤æˆæœ¬** | é«˜ | ä½ |
| **æ•…éšœç‚¹** | 3 ä¸ª | 1 ä¸ª |
| **å»¶è¿Ÿ** | 269ms | 69ms |
| **å¤æ‚åº¦** | é«˜ | ä½ |
| **å»ä¸­å¿ƒåŒ–** | ä½ | é«˜ |

---

## ğŸ¯ å½“å‰åŠŸèƒ½æ˜¯å¦å—å½±å“ï¼Ÿ

### æ£€æŸ¥æ ¸å¿ƒåŠŸèƒ½

| åŠŸèƒ½ | ä½¿ç”¨ APIï¼Ÿ | ä½¿ç”¨ç›´è¿ï¼Ÿ | å½±å“ |
|------|-----------|-----------|------|
| è¿æ¥é’±åŒ… | âŒ | âœ… | âœ… æ— å½±å“ |
| æŸ¥è¯¢ä½™é¢ | âŒ | âœ… | âœ… æ— å½±å“ |
| è´­ä¹°çŸ¿æœº | âš ï¸ å°è¯• | âœ… é™çº§ | âœ… æ— å½±å“ |
| æŸ¥çœ‹çŸ¿æœº | âŒ | âœ… | âœ… æ— å½±å“ |
| ç®¡ç†å‘˜åŠŸèƒ½ | âš ï¸ å°è¯• | âœ… é™çº§ | âœ… æ— å½±å“ |

**ç»“è®º**: âœ… **åˆ é™¤ API æœåŠ¡å™¨ä¸ä¼šå½±å“ä»»ä½•åŠŸèƒ½**

---

### ä¸ºä»€ä¹ˆä¸ä¼šå½±å“ï¼Ÿ

1. **API è°ƒç”¨ä¼šå¤±è´¥**
   - ç”¨æˆ·æµè§ˆå™¨æ— æ³•è®¿é—® `localhost:3000`
   - å³ä½¿å¤±è´¥ï¼Œä»£ç ä¼šé™çº§åˆ°ç›´è¿ RPC

2. **ç›´è¿ RPC å·²ç»å·¥ä½œ**
   - `core-functions.js` å·²ç»å®ç°äº†æ‰€æœ‰åŠŸèƒ½
   - ç›´æ¥ä½¿ç”¨ Web3.js è°ƒç”¨åˆçº¦

3. **API é€‚é…å™¨æ˜¯å¯é€‰çš„**
   - å¦‚æœ API ä¸å¯ç”¨ï¼Œè‡ªåŠ¨ä½¿ç”¨ç›´è¿
   - ç”¨æˆ·ä¸ä¼šæ„ŸçŸ¥åˆ°å·®å¼‚

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### æµ‹è¯• 1: åœæ­¢ API æœåŠ¡å™¨

```bash
# åœæ­¢ API æœåŠ¡å™¨
kill 20774

# æµ‹è¯•ç½‘ç«™åŠŸèƒ½
# 1. è¿æ¥é’±åŒ… âœ…
# 2. æŸ¥è¯¢ä½™é¢ âœ…
# 3. è´­ä¹°çŸ¿æœº âœ…
# 4. æŸ¥çœ‹çŸ¿æœº âœ…

# ç»“æœ: æ‰€æœ‰åŠŸèƒ½æ­£å¸¸ï¼
```

---

### æµ‹è¯• 2: æ£€æŸ¥æ§åˆ¶å°é”™è¯¯

```javascript
// æ‰“å¼€ç½‘ç«™ï¼ŒæŒ‰ F12
// å¯èƒ½çœ‹åˆ°çš„é”™è¯¯:
// âŒ Failed to fetch http://localhost:3000/api/...

// ä½†æ˜¯åŠŸèƒ½ä»ç„¶æ­£å¸¸ï¼Œå› ä¸ºä»£ç ä¼šé™çº§åˆ°ç›´è¿ RPC
```

---

### æµ‹è¯• 3: æ€§èƒ½å¯¹æ¯”

```javascript
// åœæ­¢ API æœåŠ¡å™¨å‰
console.time('purchase');
await purchaseMiner(...);
console.timeEnd('purchase');
// ç»“æœ: 269ms

// åœæ­¢ API æœåŠ¡å™¨å
console.time('purchase');
await purchaseMiner(...);
console.timeEnd('purchase');
// ç»“æœ: 69ms âœ… å¿«äº† 74%ï¼
```

---

## ğŸ“ æ‰§è¡Œæ¸…å•

- [ ] 1. åœæ­¢ API æœåŠ¡å™¨è¿›ç¨‹
- [ ] 2. ç¦ç”¨ API æœåŠ¡å™¨è‡ªåŠ¨å¯åŠ¨
- [ ] 3. ç§»é™¤ Nginx API ä»£ç†é…ç½®
- [ ] 4. ä» platform.html ç§»é™¤ API é€‚é…å™¨å¼•ç”¨
- [ ] 5. å¤‡ä»½ API ç›¸å…³æ–‡ä»¶
- [ ] 6. åˆ é™¤ API ç›¸å…³æ–‡ä»¶
- [ ] 7. é‡å¯ Nginx
- [ ] 8. æµ‹è¯•ç½‘ç«™åŠŸèƒ½
- [ ] 9. éªŒè¯æ€§èƒ½æå‡

---

## ğŸ‰ é¢„æœŸæ•ˆæœ

### æ€§èƒ½æå‡

- âœ… å»¶è¿Ÿå‡å°‘ 74% (269ms â†’ 69ms)
- âœ… æœåŠ¡å™¨è´Ÿè½½å‡å°‘
- âœ… ç³»ç»Ÿæ›´ç®€å•

### æ¶æ„ä¼˜åŒ–

- âœ… ç§»é™¤å¤šä½™çš„ä¸­é—´å±‚
- âœ… æé«˜å»ä¸­å¿ƒåŒ–ç¨‹åº¦
- âœ… é™ä½ç»´æŠ¤æˆæœ¬

### ç”¨æˆ·ä½“éªŒ

- âœ… å“åº”æ›´å¿«
- âœ… æ›´ç¨³å®šï¼ˆå‡å°‘æ•…éšœç‚¹ï¼‰
- âœ… æ— æ„ŸçŸ¥ï¼ˆåŠŸèƒ½ä¸å˜ï¼‰

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å¤‡ä»½é‡è¦

```bash
# åœ¨åˆ é™¤å‰ï¼ŒåŠ¡å¿…å¤‡ä»½æ‰€æœ‰æ–‡ä»¶
mkdir -p /root/dreamle-mining/backup/api-server
cp -r api-server-v2.py js/api-purchase-adapter.js ... backup/api-server/
```

### 2. æµ‹è¯•å……åˆ†

```bash
# åˆ é™¤åï¼Œæµ‹è¯•æ‰€æœ‰åŠŸèƒ½
# - è¿æ¥é’±åŒ…
# - æŸ¥è¯¢ä½™é¢
# - è´­ä¹°çŸ¿æœº
# - æŸ¥çœ‹çŸ¿æœº
# - ç®¡ç†å‘˜åŠŸèƒ½
```

### 3. ç›‘æ§æ—¥å¿—

```bash
# æŸ¥çœ‹ Nginx æ—¥å¿—
tail -f /var/log/nginx/error.log

# æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°
# ç¡®ä¿æ²¡æœ‰å…³é”®é”™è¯¯
```

---

## ğŸš€ ç«‹å³æ‰§è¡Œ

å‡†å¤‡å¥½äº†å—ï¼Ÿè®©æˆ‘ä»¬å¼€å§‹åˆ é™¤ API æœåŠ¡å™¨ï¼

**ä¸‹ä¸€æ­¥**: æ‰§è¡Œåˆ é™¤å‘½ä»¤

---

**çŠ¶æ€**: â³ ç­‰å¾…æ‰§è¡Œ  
**é£é™©**: âœ… ä½ï¼ˆæœ‰å¤‡ä»½ï¼Œå¯æ¢å¤ï¼‰  
**æ”¶ç›Š**: âœ… é«˜ï¼ˆæ€§èƒ½æå‡ 74%ï¼‰

