<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>币安钱包修复测试页面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .status-box {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .status-label {
            font-weight: bold;
        }
        
        .status-value {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        .status-yes {
            background: #4CAF50;
        }
        
        .status-no {
            background: #f44336;
        }
        
        .status-info {
            background: #2196F3;
        }
        
        .log-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-item {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-success {
            color: #4CAF50;
        }
        
        .log-warning {
            color: #FFC107;
        }
        
        .log-error {
            color: #f44336;
        }
        
        .log-info {
            color: #2196F3;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }
        
        .btn-test {
            background: #2196F3;
        }
        
        .btn-reload {
            background: #FF9800;
        }
        
        .btn-clear {
            background: #9C27B0;
        }
        
        .btn-platform {
            background: #4CAF50;
            grid-column: 1 / -1;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 币安钱包修复测试</h1>
        
        <div class="status-box">
            <div class="status-item">
                <span class="status-label">浏览器类型:</span>
                <span class="status-value status-info" id="browserType">检测中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">DApp 模式:</span>
                <span class="status-value" id="dappMode">检测中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">刷新拦截器:</span>
                <span class="status-value" id="reloadInterceptor">检测中...</span>
            </div>
            <div class="status-item">
                <span class="status-label">钱包对象:</span>
                <span class="status-value" id="walletObject">检测中...</span>
            </div>
        </div>
        
        <div class="button-group">
            <button class="btn-test" onclick="testReload()">测试刷新</button>
            <button class="btn-reload" onclick="forceReload()">强制刷新</button>
            <button class="btn-clear" onclick="clearLogs()">清除日志</button>
            <button class="btn-platform" onclick="goToPlatform()">前往平台</button>
        </div>
        
        <div class="log-box" id="logBox">
            <div class="log-item log-info">📋 日志输出区域</div>
        </div>
    </div>
    
    <script>
        // 日志函数
        function addLog(message, type = 'info') {
            const logBox = document.getElementById('logBox');
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logBox.appendChild(logItem);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(message);
        }
        
        // 检测浏览器环境
        function detectEnvironment() {
            addLog('🔍 开始检测浏览器环境...', 'info');
            
            // 检测 DApp 浏览器
            const isDAppBrowser = !!(window.BinanceChain || window.okxwallet || window.okex || window.trustwallet);
            
            // 检测具体钱包
            let walletType = '未知';
            if (window.BinanceChain) {
                walletType = '币安钱包';
                addLog('✅ 检测到币安钱包 (window.BinanceChain)', 'success');
            } else if (window.okxwallet) {
                walletType = '欧意钱包';
                addLog('✅ 检测到欧意钱包 (window.okxwallet)', 'success');
            } else if (window.okex) {
                walletType = '欧意钱包(旧版)';
                addLog('✅ 检测到欧意钱包 (window.okex)', 'success');
            } else if (window.trustwallet) {
                walletType = 'Trust钱包';
                addLog('✅ 检测到Trust钱包 (window.trustwallet)', 'success');
            } else if (window.ethereum) {
                walletType = 'Web3钱包';
                addLog('✅ 检测到Web3钱包 (window.ethereum)', 'success');
            } else {
                walletType = '无钱包';
                addLog('⚠️ 未检测到钱包对象', 'warning');
            }
            
            // 更新状态显示
            document.getElementById('browserType').textContent = walletType;
            document.getElementById('browserType').className = 'status-value status-info';
            
            document.getElementById('dappMode').textContent = isDAppBrowser ? '是' : '否';
            document.getElementById('dappMode').className = isDAppBrowser ? 'status-value status-yes' : 'status-value status-no';
            
            // 检测刷新拦截器（需要在 platform.html 中才有）
            const hasInterceptor = window.DISABLE_AUTO_RELOAD === true;
            document.getElementById('reloadInterceptor').textContent = hasInterceptor ? '已启用' : '未启用';
            document.getElementById('reloadInterceptor').className = hasInterceptor ? 'status-value status-yes' : 'status-value status-no';
            
            document.getElementById('walletObject').textContent = window.ethereum ? '存在' : '不存在';
            document.getElementById('walletObject').className = window.ethereum ? 'status-value status-yes' : 'status-value status-no';
            
            if (isDAppBrowser) {
                addLog('📱 当前在 DApp 浏览器中', 'success');
                addLog('💡 修复应该已生效，页面不应自动刷新', 'info');
            } else {
                addLog('💻 当前在桌面浏览器中', 'info');
                addLog('💡 修复仅在 DApp 浏览器中生效', 'info');
            }
        }
        
        // 测试刷新
        function testReload() {
            addLog('🧪 测试刷新功能...', 'info');
            addLog('⚠️ 如果在 DApp 浏览器中，应该会弹出确认对话框', 'warning');
            
            try {
                window.location.reload();
                addLog('❌ 刷新未被拦截（可能不在 DApp 浏览器中）', 'error');
            } catch (error) {
                addLog('✅ 刷新被拦截: ' + error.message, 'success');
            }
        }
        
        // 强制刷新
        function forceReload() {
            addLog('🔄 执行强制刷新...', 'warning');
            location.href = location.href;
        }
        
        // 清除日志
        function clearLogs() {
            const logBox = document.getElementById('logBox');
            logBox.innerHTML = '<div class="log-item log-info">📋 日志已清除</div>';
            addLog('🧹 日志已清除', 'info');
        }
        
        // 前往平台
        function goToPlatform() {
            addLog('🚀 跳转到平台页面...', 'info');
            window.location.href = '/platform.html';
        }
        
        // 页面加载时执行检测
        window.addEventListener('load', () => {
            addLog('🎉 测试页面加载完成', 'success');
            detectEnvironment();
        });
    </script>
</body>
</html>

