<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å›½ç”¨æˆ· RPC æµ‹è¯• - æ¬§æ„/å¸å®‰é’±åŒ…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .wallet-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .label {
            font-weight: 600;
            color: #555;
        }

        .value {
            color: #333;
            font-family: monospace;
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .status-good { color: #28a745; font-weight: 600; }
        .status-fair { color: #ffc107; font-weight: 600; }
        .status-poor { color: #dc3545; font-weight: 600; }

        .progress {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .recommendation {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px 20px;
            margin-top: 20px;
            border-radius: 5px;
        }

        .recommendation h3 {
            color: #1976D2;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ğŸŒ ä¸­å›½ç”¨æˆ· RPC è¿æ¥æµ‹è¯•</h1>
            <p class="subtitle">ä¸“ä¸ºæ¬§æ„é’±åŒ…å’Œå¸å®‰é’±åŒ…ä¼˜åŒ–</p>

            <div class="wallet-info">
                <h3>ğŸ“± å½“å‰é’±åŒ…ä¿¡æ¯</h3>
                <div class="info-row">
                    <span class="label">é’±åŒ…ç±»å‹:</span>
                    <span class="value" id="walletType">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="info-row">
                    <span class="label">é’±åŒ…åç§°:</span>
                    <span class="value" id="walletName">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="info-row">
                    <span class="label">åœ°ç†ä½ç½®:</span>
                    <span class="value" id="location">æ£€æµ‹ä¸­...</span>
                </div>
                <div class="info-row">
                    <span class="label">ç½‘ç»œç¯å¢ƒ:</span>
                    <span class="value" id="network">æ£€æµ‹ä¸­...</span>
                </div>
            </div>

            <button onclick="startTest()">ğŸš€ å¼€å§‹æµ‹è¯•æ‰€æœ‰ RPC</button>
            <button onclick="testBestRPC()">âš¡ æµ‹è¯•æœ€ä½³ RPC</button>
            <button onclick="testOKXOptimized()">ğŸŸ¢ æµ‹è¯•æ¬§æ„ä¼˜åŒ–èŠ‚ç‚¹</button>
            <button onclick="testBinanceOptimized()">ğŸŸ¡ æµ‹è¯•å¸å®‰ä¼˜åŒ–èŠ‚ç‚¹</button>

            <div class="progress" id="progressBar" style="display: none;">
                <div class="progress-bar" id="progressBarInner">0%</div>
            </div>

            <div id="results"></div>
        </div>
    </div>

    <script>
        // RPC èŠ‚ç‚¹é…ç½®ï¼ˆä¸ config/contracts.js ä¸€è‡´ï¼‰
        const RPC_NODES = [
            { name: 'drpc.org (ä¸»åŠ›)', url: 'https://lb.drpc.org/bsc/AqlGpHrYB01Fo1dFtBRULdHcTuavm9wR8L7hwg8TMB_n', priority: 1 },
            { name: 'BSC å®˜æ–¹ 1', url: 'https://bsc-dataseed1.binance.org', priority: 2 },
            { name: 'BSC å®˜æ–¹ 2', url: 'https://bsc-dataseed2.binance.org', priority: 2 },
            { name: 'PublicNode', url: 'https://bsc-rpc.publicnode.com', priority: 3 },
            { name: '1RPC', url: 'https://1rpc.io/bnb', priority: 4 },
            { name: 'NodeReal', url: 'https://bsc-mainnet.nodereal.io/v1/1659dfb40aa24bbb8153a677b98064d7', priority: 5 },
            { name: 'BSC å®˜æ–¹ 3', url: 'https://bsc-dataseed3.binance.org', priority: 6 },
            { name: 'BSC å®˜æ–¹ 4', url: 'https://bsc-dataseed4.binance.org', priority: 6 }
        ];

        // æ£€æµ‹é’±åŒ…ç±»å‹
        function detectWallet() {
            if (window.BinanceChain) {
                return { type: 'Binance', name: 'å¸å®‰é’±åŒ…', icon: 'ğŸŸ¡' };
            } else if (window.okxwallet || window.okex) {
                return { type: 'OKX', name: 'æ¬§æ„é’±åŒ…', icon: 'ğŸŸ¢' };
            } else if (window.ethereum) {
                return { type: 'Other', name: 'å…¶ä»–é’±åŒ…', icon: 'ğŸ’¼' };
            } else {
                return { type: 'None', name: 'æœªæ£€æµ‹åˆ°é’±åŒ…', icon: 'âŒ' };
            }
        }

        // æ£€æµ‹åœ°ç†ä½ç½®ï¼ˆç®€å•åˆ¤æ–­ï¼‰
        async function detectLocation() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                return {
                    country: data.country_name || 'æœªçŸ¥',
                    city: data.city || 'æœªçŸ¥',
                    isp: data.org || 'æœªçŸ¥'
                };
            } catch (error) {
                return { country: 'æ£€æµ‹å¤±è´¥', city: '', isp: '' };
            }
        }

        // æµ‹è¯•å•ä¸ª RPC
        async function testRPC(rpc, timeout = 5000) {
            const startTime = performance.now();
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);

                const response = await fetch(rpc.url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'eth_chainId',
                        params: [],
                        id: 1
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const latency = Math.round(performance.now() - startTime);

                if (response.ok) {
                    const data = await response.json();
                    if (data.result === '0x38') {
                        return { success: true, latency, error: null };
                    } else {
                        return { success: false, latency, error: 'é”™è¯¯çš„é“¾ID' };
                    }
                } else {
                    return { success: false, latency, error: `HTTP ${response.status}` };
                }
            } catch (error) {
                const latency = Math.round(performance.now() - startTime);
                return { 
                    success: false, 
                    latency, 
                    error: error.name === 'AbortError' ? 'è¶…æ—¶' : error.message 
                };
            }
        }

        // å¼€å§‹æµ‹è¯•
        async function startTest() {
            const resultsDiv = document.getElementById('results');
            const progressBar = document.getElementById('progressBar');
            const progressBarInner = document.getElementById('progressBarInner');

            progressBar.style.display = 'block';
            resultsDiv.innerHTML = '<h3>ğŸ” æ­£åœ¨æµ‹è¯•æ‰€æœ‰ RPC èŠ‚ç‚¹...</h3>';

            const results = [];
            
            for (let i = 0; i < RPC_NODES.length; i++) {
                const rpc = RPC_NODES[i];
                const progress = Math.round(((i + 1) / RPC_NODES.length) * 100);
                progressBarInner.style.width = progress + '%';
                progressBarInner.textContent = `æµ‹è¯•ä¸­... ${i + 1}/${RPC_NODES.length}`;

                const result = await testRPC(rpc);
                results.push({ ...rpc, ...result });
            }

            progressBar.style.display = 'none';
            displayResults(results);
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResults(results) {
            const resultsDiv = document.getElementById('results');
            
            // æ’åºï¼šæˆåŠŸçš„åœ¨å‰ï¼ŒæŒ‰å»¶è¿Ÿæ’åº
            results.sort((a, b) => {
                if (a.success && !b.success) return -1;
                if (!a.success && b.success) return 1;
                return a.latency - b.latency;
            });

            let html = '<h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>';
            html += '<table><thead><tr><th>èŠ‚ç‚¹</th><th>å»¶è¿Ÿ</th><th>çŠ¶æ€</th><th>ä¼˜å…ˆçº§</th></tr></thead><tbody>';

            results.forEach(result => {
                const statusClass = result.success ? 
                    (result.latency < 200 ? 'status-good' : result.latency < 500 ? 'status-fair' : 'status-poor') : 
                    'status-poor';
                
                const statusText = result.success ? 
                    `${result.latency}ms` : 
                    result.error;

                const statusIcon = result.success ? 'âœ…' : 'âŒ';

                html += `<tr>
                    <td>${result.name}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>${statusIcon}</td>
                    <td>P${result.priority}</td>
                </tr>`;
            });

            html += '</tbody></table>';

            // æ¨è
            const bestRPC = results.find(r => r.success);
            if (bestRPC) {
                const wallet = detectWallet();
                html += '<div class="recommendation">';
                html += '<h3>ğŸ’¡ æ¨èé…ç½®</h3>';
                html += `<p><strong>æ‚¨çš„é’±åŒ…:</strong> ${wallet.icon} ${wallet.name}</p>`;
                html += `<p><strong>æœ€ä½³èŠ‚ç‚¹:</strong> ${bestRPC.name} (${bestRPC.latency}ms)</p>`;
                
                if (wallet.type === 'OKX') {
                    html += '<p><strong>æ¬§æ„é’±åŒ…ä¼˜åŒ–å»ºè®®:</strong> ä½¿ç”¨ BSC å®˜æ–¹èŠ‚ç‚¹æˆ– drpc.org</p>';
                } else if (wallet.type === 'Binance') {
                    html += '<p><strong>å¸å®‰é’±åŒ…ä¼˜åŒ–å»ºè®®:</strong> ä½¿ç”¨ BSC å®˜æ–¹èŠ‚ç‚¹</p>';
                }
                
                html += '</div>';
            }

            resultsDiv.innerHTML = html;
        }

        // æµ‹è¯•æœ€ä½³ RPC
        async function testBestRPC() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>âš¡ æ­£åœ¨æµ‹è¯•æœ€ä½³ RPC...</h3>';

            const result = await testRPC(RPC_NODES[0]);
            
            let html = '<h3>âš¡ æœ€ä½³ RPC æµ‹è¯•ç»“æœ</h3>';
            html += `<div class="wallet-info">`;
            html += `<div class="info-row"><span class="label">èŠ‚ç‚¹:</span><span class="value">${RPC_NODES[0].name}</span></div>`;
            html += `<div class="info-row"><span class="label">URL:</span><span class="value">${RPC_NODES[0].url}</span></div>`;
            html += `<div class="info-row"><span class="label">å»¶è¿Ÿ:</span><span class="value ${result.success ? 'status-good' : 'status-poor'}">${result.success ? result.latency + 'ms' : result.error}</span></div>`;
            html += `<div class="info-row"><span class="label">çŠ¶æ€:</span><span class="value">${result.success ? 'âœ… å¯ç”¨' : 'âŒ ä¸å¯ç”¨'}</span></div>`;
            html += `</div>`;

            resultsDiv.innerHTML = html;
        }

        // æµ‹è¯•æ¬§æ„ä¼˜åŒ–èŠ‚ç‚¹
        async function testOKXOptimized() {
            const okxNodes = RPC_NODES.filter(r => r.name.includes('BSC å®˜æ–¹') || r.name.includes('drpc'));
            await testSpecificNodes(okxNodes, 'ğŸŸ¢ æ¬§æ„é’±åŒ…ä¼˜åŒ–èŠ‚ç‚¹');
        }

        // æµ‹è¯•å¸å®‰ä¼˜åŒ–èŠ‚ç‚¹
        async function testBinanceOptimized() {
            const binanceNodes = RPC_NODES.filter(r => r.name.includes('BSC å®˜æ–¹'));
            await testSpecificNodes(binanceNodes, 'ğŸŸ¡ å¸å®‰é’±åŒ…ä¼˜åŒ–èŠ‚ç‚¹');
        }

        // æµ‹è¯•ç‰¹å®šèŠ‚ç‚¹
        async function testSpecificNodes(nodes, title) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<h3>${title}</h3><p>æ­£åœ¨æµ‹è¯•...</p>`;

            const results = [];
            for (const node of nodes) {
                const result = await testRPC(node);
                results.push({ ...node, ...result });
            }

            displayResults(results);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', async () => {
            const wallet = detectWallet();
            document.getElementById('walletType').textContent = wallet.type;
            document.getElementById('walletName').textContent = wallet.icon + ' ' + wallet.name;

            const location = await detectLocation();
            document.getElementById('location').textContent = `${location.country} ${location.city}`;
            document.getElementById('network').textContent = location.isp;

            // è‡ªåŠ¨å¼€å§‹æµ‹è¯•
            setTimeout(startTest, 1000);
        });
    </script>
</body>
</html>

