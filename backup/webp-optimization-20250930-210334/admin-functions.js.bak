/**
 * ç®¡ç†å‘˜åŠŸèƒ½æ¨¡å—
 * åŒ…å«ç‰¹æ®Šæ¨èäººç®¡ç†ã€æµåŠ¨æ€§ç®¡ç†ã€æå–ç­‰åŠŸèƒ½
 * 
 * æ—¥æœŸ: 2025-09-30
 */

(function() {
    'use strict';
    
    console.log('ğŸ”§ åŠ è½½ç®¡ç†å‘˜åŠŸèƒ½æ¨¡å—...');

    // ç®¡ç†å‘˜åœ°å€
    const ADMIN_ADDRESS = '0xfC3b7735Dae4C7AB3Ab85Ffa9987661e795B74b7';

    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
     */
    window.isAdminUser = function() {
        if (!window.userAccount) return false;
        return window.userAccount.toLowerCase() === ADMIN_ADDRESS.toLowerCase();
    };

    // ==================== ç‰¹æ®Šæ¨èäººç®¡ç† ====================

    /**
     * æ·»åŠ ç‰¹æ®Šæ¨èäºº
     * @param {string} referrerAddress - æ¨èäººåœ°å€
     */
    window.addSpecialReferrer = async function(referrerAddress) {
        console.log(`â• å‡†å¤‡æ·»åŠ ç‰¹æ®Šæ¨èäºº: ${referrerAddress}`);

        if (!window.isConnected || !window.userAccount) {
            window.showMessage('è¯·å…ˆè¿æ¥é’±åŒ…', 'warning');
            return;
        }

        if (!window.isAdminUser()) {
            window.showMessage('âŒ åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œæ­¤æ“ä½œ', 'error');
            return;
        }

        try {
            // éªŒè¯åœ°å€æ ¼å¼
            if (!window.web3.utils.isAddress(referrerAddress)) {
                throw new Error('æ— æ•ˆçš„åœ°å€æ ¼å¼');
            }

            const confirmed = confirm(
                `ç¡®è®¤æ·»åŠ ç‰¹æ®Šæ¨èäººï¼Ÿ\n\n` +
                `åœ°å€: ${referrerAddress}\n\n` +
                `ç‰¹æ®Šæ¨èäººå°†äº«æœ‰é¢å¤–çš„å¥–åŠ±`
            );

            if (!confirmed) {
                window.showMessage('å·²å–æ¶ˆæ“ä½œ', 'info');
                return;
            }

            // ä¼˜å…ˆä½¿ç”¨APIæ–¹æ³•
            if (window.addSpecialReferrerViaAPI) {
                try {
                    console.log('ğŸŒ ä½¿ç”¨APIæ·»åŠ ç‰¹æ®Šæ¨èäºº');
                    await window.addSpecialReferrerViaAPI(referrerAddress);
                    
                    window.showMessage(`âœ… ç‰¹æ®Šæ¨èäººæ·»åŠ æˆåŠŸï¼`, 'success');
                    return;
                } catch (error) {
                    console.error('âŒ APIæ·»åŠ å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åŸå§‹æ–¹æ³•:', error);
                }
            }

            // åŸå§‹æ–¹æ³•ï¼ˆå›é€€ï¼‰
            if (!window.unifiedContract) {
                throw new Error('åˆçº¦æœªåˆå§‹åŒ–');
            }

            window.showMessage('æ­£åœ¨æ·»åŠ ç‰¹æ®Šæ¨èäºº...', 'info');

            const gasEstimate = await window.unifiedContract.methods.addSpecialReferrer(referrerAddress).estimateGas({
                from: window.userAccount
            });

            const gasLimit = window.safeGasLimit ? window.safeGasLimit(gasEstimate, 1.2) : Math.floor(gasEstimate * 1.2);

            const result = await window.unifiedContract.methods.addSpecialReferrer(referrerAddress).send({
                from: window.userAccount,
                gas: gasLimit
            });

            console.log(`âœ… ç‰¹æ®Šæ¨èäººæ·»åŠ æˆåŠŸ:`, result);
            window.showMessage(`âœ… ç‰¹æ®Šæ¨èäººæ·»åŠ æˆåŠŸï¼`, 'success');

        } catch (error) {
            console.error('âŒ æ·»åŠ å¤±è´¥:', error);
            window.showMessage(`âŒ æ·»åŠ å¤±è´¥: ${error.message}`, 'error');
        }
    };

    /**
     * ç§»é™¤ç‰¹æ®Šæ¨èäºº
     * @param {string} referrerAddress - æ¨èäººåœ°å€
     */
    window.removeSpecialReferrer = async function(referrerAddress) {
        console.log(`â– å‡†å¤‡ç§»é™¤ç‰¹æ®Šæ¨èäºº: ${referrerAddress}`);

        if (!window.isConnected || !window.userAccount) {
            window.showMessage('è¯·å…ˆè¿æ¥é’±åŒ…', 'warning');
            return;
        }

        if (!window.isAdminUser()) {
            window.showMessage('âŒ åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œæ­¤æ“ä½œ', 'error');
            return;
        }

        try {
            // éªŒè¯åœ°å€æ ¼å¼
            if (!window.web3.utils.isAddress(referrerAddress)) {
                throw new Error('æ— æ•ˆçš„åœ°å€æ ¼å¼');
            }

            const confirmed = confirm(
                `ç¡®è®¤ç§»é™¤ç‰¹æ®Šæ¨èäººï¼Ÿ\n\n` +
                `åœ°å€: ${referrerAddress}\n\n` +
                `ç§»é™¤åè¯¥åœ°å€å°†å¤±å»ç‰¹æ®Šæ¨èäººæƒé™`
            );

            if (!confirmed) {
                window.showMessage('å·²å–æ¶ˆæ“ä½œ', 'info');
                return;
            }

            // ä¼˜å…ˆä½¿ç”¨APIæ–¹æ³•
            if (window.removeSpecialReferrerViaAPI) {
                try {
                    console.log('ğŸŒ ä½¿ç”¨APIç§»é™¤ç‰¹æ®Šæ¨èäºº');
                    await window.removeSpecialReferrerViaAPI(referrerAddress);
                    
                    window.showMessage(`âœ… ç‰¹æ®Šæ¨èäººç§»é™¤æˆåŠŸï¼`, 'success');
                    return;
                } catch (error) {
                    console.error('âŒ APIç§»é™¤å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åŸå§‹æ–¹æ³•:', error);
                }
            }

            // åŸå§‹æ–¹æ³•ï¼ˆå›é€€ï¼‰
            if (!window.unifiedContract) {
                throw new Error('åˆçº¦æœªåˆå§‹åŒ–');
            }

            window.showMessage('æ­£åœ¨ç§»é™¤ç‰¹æ®Šæ¨èäºº...', 'info');

            const gasEstimate = await window.unifiedContract.methods.removeSpecialReferrer(referrerAddress).estimateGas({
                from: window.userAccount
            });

            const gasLimit = window.safeGasLimit ? window.safeGasLimit(gasEstimate, 1.2) : Math.floor(gasEstimate * 1.2);

            const result = await window.unifiedContract.methods.removeSpecialReferrer(referrerAddress).send({
                from: window.userAccount,
                gas: gasLimit
            });

            console.log(`âœ… ç‰¹æ®Šæ¨èäººç§»é™¤æˆåŠŸ:`, result);
            window.showMessage(`âœ… ç‰¹æ®Šæ¨èäººç§»é™¤æˆåŠŸï¼`, 'success');

        } catch (error) {
            console.error('âŒ ç§»é™¤å¤±è´¥:', error);
            window.showMessage(`âŒ ç§»é™¤å¤±è´¥: ${error.message}`, 'error');
        }
    };

    // ==================== æµåŠ¨æ€§ç®¡ç† ====================

    /**
     * æ³¨å…¥æµåŠ¨æ€§
     * @param {string} usdtAmount - USDTæ•°é‡ï¼ˆweiï¼‰
     * @param {string} drmAmount - DRMæ•°é‡ï¼ˆweiï¼‰
     */
    window.adminInjectLiquidity = async function(usdtAmount, drmAmount) {
        console.log(`ğŸ’§ å‡†å¤‡æ³¨å…¥æµåŠ¨æ€§: USDT=${usdtAmount}, DRM=${drmAmount}`);

        if (!window.isConnected || !window.userAccount) {
            window.showMessage('è¯·å…ˆè¿æ¥é’±åŒ…', 'warning');
            return;
        }

        if (!window.isAdminUser()) {
            window.showMessage('âŒ åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œæ­¤æ“ä½œ', 'error');
            return;
        }

        try {
            const usdtInEther = window.web3.utils.fromWei(usdtAmount, 'ether');
            const drmInEther = window.web3.utils.fromWei(drmAmount, 'ether');

            const confirmed = confirm(
                `ç¡®è®¤æ³¨å…¥æµåŠ¨æ€§ï¼Ÿ\n\n` +
                `USDT: ${usdtInEther}\n` +
                `DRM: ${drmInEther}\n\n` +
                `âš ï¸ è¯·ç¡®ä¿æ‚¨æœ‰è¶³å¤Ÿçš„ä»£å¸ä½™é¢å¹¶å·²æˆæƒ`
            );

            if (!confirmed) {
                window.showMessage('å·²å–æ¶ˆæ“ä½œ', 'info');
                return;
            }

            // ä¼˜å…ˆä½¿ç”¨APIæ–¹æ³•
            if (window.adminInjectLiquidityViaAPI) {
                try {
                    console.log('ğŸŒ ä½¿ç”¨APIæ³¨å…¥æµåŠ¨æ€§');
                    await window.adminInjectLiquidityViaAPI(usdtAmount, drmAmount);
                    
                    window.showMessage(`âœ… æµåŠ¨æ€§æ³¨å…¥æˆåŠŸï¼`, 'success');
                    return;
                } catch (error) {
                    console.error('âŒ APIæ³¨å…¥å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åŸå§‹æ–¹æ³•:', error);
                }
            }

            // åŸå§‹æ–¹æ³•ï¼ˆå›é€€ï¼‰
            if (!window.unifiedContract) {
                throw new Error('åˆçº¦æœªåˆå§‹åŒ–');
            }

            window.showMessage('æ­£åœ¨æ³¨å…¥æµåŠ¨æ€§...', 'info');

            const gasEstimate = await window.unifiedContract.methods.adminInjectLiquidity(usdtAmount, drmAmount).estimateGas({
                from: window.userAccount
            });

            const gasLimit = window.safeGasLimit ? window.safeGasLimit(gasEstimate, 1.2) : Math.floor(gasEstimate * 1.2);

            const result = await window.unifiedContract.methods.adminInjectLiquidity(usdtAmount, drmAmount).send({
                from: window.userAccount,
                gas: gasLimit
            });

            console.log(`âœ… æµåŠ¨æ€§æ³¨å…¥æˆåŠŸ:`, result);
            window.showMessage(`âœ… æµåŠ¨æ€§æ³¨å…¥æˆåŠŸï¼`, 'success');

        } catch (error) {
            console.error('âŒ æ³¨å…¥å¤±è´¥:', error);
            window.showMessage(`âŒ æ³¨å…¥å¤±è´¥: ${error.message}`, 'error');
        }
    };

    /**
     * ç®¡ç†å‘˜æå–
     * @param {string} tokenAddress - ä»£å¸åœ°å€
     * @param {string} amount - æå–æ•°é‡ï¼ˆweiï¼‰
     */
    window.adminWithdraw = async function(tokenAddress, amount) {
        console.log(`ğŸ’¸ å‡†å¤‡æå–ä»£å¸: token=${tokenAddress}, amount=${amount}`);

        if (!window.isConnected || !window.userAccount) {
            window.showMessage('è¯·å…ˆè¿æ¥é’±åŒ…', 'warning');
            return;
        }

        if (!window.isAdminUser()) {
            window.showMessage('âŒ åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œæ­¤æ“ä½œ', 'error');
            return;
        }

        try {
            // éªŒè¯åœ°å€æ ¼å¼
            if (!window.web3.utils.isAddress(tokenAddress)) {
                throw new Error('æ— æ•ˆçš„ä»£å¸åœ°å€æ ¼å¼');
            }

            const amountInEther = window.web3.utils.fromWei(amount, 'ether');

            const confirmed = confirm(
                `ç¡®è®¤æå–ä»£å¸ï¼Ÿ\n\n` +
                `ä»£å¸åœ°å€: ${tokenAddress}\n` +
                `æ•°é‡: ${amountInEther}\n\n` +
                `âš ï¸ æ­¤æ“ä½œä¸å¯æ’¤é”€`
            );

            if (!confirmed) {
                window.showMessage('å·²å–æ¶ˆæ“ä½œ', 'info');
                return;
            }

            // ä¼˜å…ˆä½¿ç”¨APIæ–¹æ³•
            if (window.adminWithdrawViaAPI) {
                try {
                    console.log('ğŸŒ ä½¿ç”¨APIæå–ä»£å¸');
                    await window.adminWithdrawViaAPI(tokenAddress, amount);
                    
                    window.showMessage(`âœ… ä»£å¸æå–æˆåŠŸï¼`, 'success');
                    return;
                } catch (error) {
                    console.error('âŒ APIæå–å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åŸå§‹æ–¹æ³•:', error);
                }
            }

            // åŸå§‹æ–¹æ³•ï¼ˆå›é€€ï¼‰
            if (!window.unifiedContract) {
                throw new Error('åˆçº¦æœªåˆå§‹åŒ–');
            }

            window.showMessage('æ­£åœ¨æå–ä»£å¸...', 'info');

            const gasEstimate = await window.unifiedContract.methods.adminWithdraw(tokenAddress, amount).estimateGas({
                from: window.userAccount
            });

            const gasLimit = window.safeGasLimit ? window.safeGasLimit(gasEstimate, 1.2) : Math.floor(gasEstimate * 1.2);

            const result = await window.unifiedContract.methods.adminWithdraw(tokenAddress, amount).send({
                from: window.userAccount,
                gas: gasLimit
            });

            console.log(`âœ… ä»£å¸æå–æˆåŠŸ:`, result);
            window.showMessage(`âœ… ä»£å¸æå–æˆåŠŸï¼`, 'success');

        } catch (error) {
            console.error('âŒ æå–å¤±è´¥:', error);
            window.showMessage(`âŒ æå–å¤±è´¥: ${error.message}`, 'error');
        }
    };

    // ==================== ç³»ç»Ÿç®¡ç† ====================

    /**
     * ç´§æ€¥æš‚åœ
     */
    window.emergencyPause = async function() {
        console.log(`ğŸ”´ å‡†å¤‡ç´§æ€¥æš‚åœåˆçº¦`);

        if (!window.isConnected || !window.userAccount) {
            window.showMessage('è¯·å…ˆè¿æ¥é’±åŒ…', 'warning');
            return;
        }

        if (!window.isAdminUser()) {
            window.showMessage('âŒ åªæœ‰ç®¡ç†å‘˜å¯ä»¥æ‰§è¡Œæ­¤æ“ä½œ', 'error');
            return;
        }

        try {
            const confirmed = confirm(
                `âš ï¸ ç¡®è®¤ç´§æ€¥æš‚åœåˆçº¦ï¼Ÿ\n\n` +
                `æ­¤æ“ä½œå°†æš‚åœæ‰€æœ‰åˆçº¦åŠŸèƒ½\n` +
                `åŒ…æ‹¬è´­ä¹°ã€è½¬è®©ã€é¢†å–ç­‰\n\n` +
                `è¯·è°¨æ…æ“ä½œï¼`
            );

            if (!confirmed) {
                window.showMessage('å·²å–æ¶ˆæ“ä½œ', 'info');
                return;
            }

            // äºŒæ¬¡ç¡®è®¤
            const doubleConfirm = confirm('å†æ¬¡ç¡®è®¤ï¼šæ‚¨ç¡®å®šè¦ç´§æ€¥æš‚åœåˆçº¦å—ï¼Ÿ');
            if (!doubleConfirm) {
                window.showMessage('å·²å–æ¶ˆæ“ä½œ', 'info');
                return;
            }

            // ä¼˜å…ˆä½¿ç”¨APIæ–¹æ³•
            if (window.emergencyPauseViaAPI) {
                try {
                    console.log('ğŸŒ ä½¿ç”¨APIç´§æ€¥æš‚åœ');
                    await window.emergencyPauseViaAPI();
                    
                    window.showMessage(`âœ… åˆçº¦å·²ç´§æ€¥æš‚åœï¼`, 'success');
                    return;
                } catch (error) {
                    console.error('âŒ APIæš‚åœå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åŸå§‹æ–¹æ³•:', error);
                }
            }

            // åŸå§‹æ–¹æ³•ï¼ˆå›é€€ï¼‰
            if (!window.unifiedContract) {
                throw new Error('åˆçº¦æœªåˆå§‹åŒ–');
            }

            window.showMessage('æ­£åœ¨ç´§æ€¥æš‚åœåˆçº¦...', 'info');

            const result = await window.unifiedContract.methods.emergencyPause().send({
                from: window.userAccount
            });

            console.log(`âœ… åˆçº¦å·²ç´§æ€¥æš‚åœ:`, result);
            window.showMessage(`âœ… åˆçº¦å·²ç´§æ€¥æš‚åœï¼`, 'success');

        } catch (error) {
            console.error('âŒ æš‚åœå¤±è´¥:', error);
            window.showMessage(`âŒ æš‚åœå¤±è´¥: ${error.message}`, 'error');
        }
    };

    /**
     * æ›´æ–°è¿‡æœŸçŸ¿æœº
     * @param {string} userAddress - ç”¨æˆ·åœ°å€
     */
    window.updateExpiredMiners = async function(userAddress) {
        console.log(`ğŸ”„ å‡†å¤‡æ›´æ–°è¿‡æœŸçŸ¿æœº: ${userAddress}`);

        if (!window.isConnected || !window.userAccount) {
            window.showMessage('è¯·å…ˆè¿æ¥é’±åŒ…', 'warning');
            return;
        }

        try {
            // éªŒè¯åœ°å€æ ¼å¼
            if (!window.web3.utils.isAddress(userAddress)) {
                throw new Error('æ— æ•ˆçš„åœ°å€æ ¼å¼');
            }

            // ä¼˜å…ˆä½¿ç”¨APIæ–¹æ³•
            if (window.updateExpiredMinersViaAPI) {
                try {
                    console.log('ğŸŒ ä½¿ç”¨APIæ›´æ–°è¿‡æœŸçŸ¿æœº');
                    await window.updateExpiredMinersViaAPI(userAddress);
                    
                    window.showMessage(`âœ… è¿‡æœŸçŸ¿æœºæ›´æ–°æˆåŠŸï¼`, 'success');
                    return;
                } catch (error) {
                    console.error('âŒ APIæ›´æ–°å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨åŸå§‹æ–¹æ³•:', error);
                }
            }

            // åŸå§‹æ–¹æ³•ï¼ˆå›é€€ï¼‰
            if (!window.unifiedContract) {
                throw new Error('åˆçº¦æœªåˆå§‹åŒ–');
            }

            window.showMessage('æ­£åœ¨æ›´æ–°è¿‡æœŸçŸ¿æœº...', 'info');

            const gasEstimate = await window.unifiedContract.methods.updateExpiredMiners(userAddress).estimateGas({
                from: window.userAccount
            });

            const gasLimit = window.safeGasLimit ? window.safeGasLimit(gasEstimate, 1.2) : Math.floor(gasEstimate * 1.2);

            const result = await window.unifiedContract.methods.updateExpiredMiners(userAddress).send({
                from: window.userAccount,
                gas: gasLimit
            });

            console.log(`âœ… è¿‡æœŸçŸ¿æœºæ›´æ–°æˆåŠŸ:`, result);
            window.showMessage(`âœ… è¿‡æœŸçŸ¿æœºæ›´æ–°æˆåŠŸï¼`, 'success');

        } catch (error) {
            console.error('âŒ æ›´æ–°å¤±è´¥:', error);
            window.showMessage(`âŒ æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
        }
    };

    console.log('âœ… ç®¡ç†å‘˜åŠŸèƒ½æ¨¡å—åŠ è½½å®Œæˆ');
    console.log('   - addSpecialReferrer() - æ·»åŠ ç‰¹æ®Šæ¨èäºº');
    console.log('   - removeSpecialReferrer() - ç§»é™¤ç‰¹æ®Šæ¨èäºº');
    console.log('   - adminInjectLiquidity() - æ³¨å…¥æµåŠ¨æ€§');
    console.log('   - adminWithdraw() - ç®¡ç†å‘˜æå–');
    console.log('   - emergencyPause() - ç´§æ€¥æš‚åœ');
    console.log('   - updateExpiredMiners() - æ›´æ–°è¿‡æœŸçŸ¿æœº');

})();

