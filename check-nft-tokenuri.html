<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ£€æŸ¥ NFT TokenURI - Dreamle Mining</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        button {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” æ£€æŸ¥ NFT TokenURI é—®é¢˜</h1>

        <div class="input-group">
            <label>é’±åŒ…åœ°å€ï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ™ä½¿ç”¨å½“å‰è¿æ¥çš„é’±åŒ…ï¼‰</label>
            <input type="text" id="walletAddress" placeholder="0x...">
        </div>

        <button onclick="connectWallet()">ğŸ”— è¿æ¥é’±åŒ…</button>
        <button onclick="checkNFTs()">ğŸ” æ£€æŸ¥æˆ‘çš„ NFT</button>
        <button onclick="checkSpecificToken()">ğŸ” æ£€æŸ¥ç‰¹å®š Token</button>

        <div id="result"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script src="config/contracts.js"></script>
    <script src="js/unified-system-v18-abi.js"></script>

    <script>
        let web3;
        let contract;
        let userAccount;

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('è¯·å®‰è£… MetaMask æˆ–å…¶ä»– Web3 é’±åŒ…');
                    return;
                }

                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts' 
                });
                
                userAccount = accounts[0];
                document.getElementById('walletAddress').value = userAccount;

                web3 = new Web3(window.ethereum);

                const chainId = await web3.eth.getChainId();
                if (chainId !== 56) {
                    alert('è¯·åˆ‡æ¢åˆ° BSC ä¸»ç½‘ï¼ˆChain ID: 56ï¼‰');
                    return;
                }

                const contractAddress = window.CONTRACT_ADDRESSES.UNIFIED_SYSTEM;
                const abi = window.UNIFIED_SYSTEM_V18_ABI;
                
                contract = new web3.eth.Contract(abi, contractAddress);

                showResult('âœ… é’±åŒ…è¿æ¥æˆåŠŸï¼\nåœ°å€: ' + userAccount, 'success');

            } catch (error) {
                showResult('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function checkNFTs() {
            if (!contract) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }

            const address = document.getElementById('walletAddress').value || userAccount;
            if (!address) {
                alert('è¯·è¾“å…¥é’±åŒ…åœ°å€æˆ–è¿æ¥é’±åŒ…');
                return;
            }

            try {
                showResult('æ­£åœ¨æ£€æŸ¥ ' + address + ' çš„ NFT...', 'info');

                // è·å–ç”¨æˆ·çš„æ‰€æœ‰ NFT
                const tokenIds = await contract.methods.getUserMiners(address).call();
                
                if (tokenIds.length === 0) {
                    showResult('è¯¥åœ°å€æ²¡æœ‰ NFT', 'error');
                    return;
                }

                let result = `æ‰¾åˆ° ${tokenIds.length} ä¸ª NFT:\n\n`;
                result += '<table><tr><th>Token ID</th><th>ç­‰çº§</th><th>TokenURI</th><th>é—®é¢˜</th></tr>';

                for (let tokenId of tokenIds) {
                    // è·å–çŸ¿æœºä¿¡æ¯
                    const minerInfo = await contract.methods.miners(tokenId).call();
                    const level = minerInfo.level;

                    // è·å– tokenURI
                    const tokenURI = await contract.methods.tokenURI(tokenId).call();

                    // æ£€æŸ¥ tokenURI æ˜¯å¦æ­£ç¡®
                    const expectedURI = `https://www.dreamlewebai.com/api/metadata/${tokenId}.json`;
                    const isCorrect = tokenURI === expectedURI;

                    result += `<tr>
                        <td>#${tokenId}</td>
                        <td>LV.${level}</td>
                        <td style="font-size: 11px;">${tokenURI}</td>
                        <td>${isCorrect ? 'âœ…' : 'âŒ é”™è¯¯'}</td>
                    </tr>`;
                }

                result += '</table>';

                // æ£€æŸ¥åˆçº¦çš„ tokenURI å®ç°
                result += '\n\n<h3>ğŸ” é—®é¢˜è¯Šæ–­ï¼š</h3>';
                
                const token1URI = await contract.methods.tokenURI(1).call();
                const token2URI = await contract.methods.tokenURI(2).call();
                const token999URI = await contract.methods.tokenURI(999).call();

                result += `<div class="result-box">`;
                result += `Token #1 URI: ${token1URI}\n`;
                result += `Token #2 URI: ${token2URI}\n`;
                result += `Token #999 URI: ${token999URI}\n\n`;

                if (token1URI === token2URI && token2URI === token999URI) {
                    result += `âŒ <strong>é—®é¢˜ç¡®è®¤ï¼šåˆçº¦çš„ tokenURI å‡½æ•°è¿”å›å›ºå®šå€¼ï¼</strong>\n\n`;
                    result += `æ‰€æœ‰ token éƒ½è¿”å›ç›¸åŒçš„ URIï¼Œè¿™æ˜¯åˆçº¦å±‚é¢çš„ bugã€‚\n\n`;
                    result += `<strong>è§£å†³æ–¹æ¡ˆï¼š</strong>\n`;
                    result += `1. åˆçº¦éœ€è¦ä¿®å¤ tokenURI å‡½æ•°ï¼Œä½¿å…¶è¿”å› baseURI + tokenId + ".json"\n`;
                    result += `2. æˆ–è€…ä½¿ç”¨åŠ¨æ€ metadata API æ ¹æ® tokenId æŸ¥è¯¢çŸ¿æœºç­‰çº§\n`;
                    result += `3. å½“å‰ä¸´æ—¶æ–¹æ¡ˆï¼šä½¿ç”¨ PHP API åŠ¨æ€ç”Ÿæˆ metadata\n`;
                } else {
                    result += `âœ… tokenURI å‡½æ•°å·¥ä½œæ­£å¸¸\n`;
                }

                result += `</div>`;

                document.getElementById('result').innerHTML = result;

            } catch (error) {
                showResult('âŒ æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        async function checkSpecificToken() {
            const tokenId = prompt('è¯·è¾“å…¥è¦æ£€æŸ¥çš„ Token ID:');
            if (!tokenId) return;

            if (!contract) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }

            try {
                // è·å–çŸ¿æœºä¿¡æ¯
                const minerInfo = await contract.methods.miners(tokenId).call();
                const level = minerInfo.level;
                const purchaseTime = new Date(minerInfo.purchaseTime * 1000);

                // è·å– tokenURI
                const tokenURI = await contract.methods.tokenURI(tokenId).call();

                let result = `<h3>Token #${tokenId} è¯¦ç»†ä¿¡æ¯ï¼š</h3>`;
                result += `<div class="result-box">`;
                result += `ç­‰çº§: LV.${level}\n`;
                result += `è´­ä¹°æ—¶é—´: ${purchaseTime.toLocaleString()}\n`;
                result += `TokenURI: ${tokenURI}\n\n`;
                result += `æœŸæœ›çš„ URI: https://www.dreamlewebai.com/api/metadata/${tokenId}.json\n`;
                result += `å®é™…çš„ URI: ${tokenURI}\n\n`;
                
                if (tokenURI.includes(`${tokenId}.json`)) {
                    result += `âœ… TokenURI æ­£ç¡®\n`;
                } else {
                    result += `âŒ TokenURI é”™è¯¯ï¼ˆåº”è¯¥åŒ…å« tokenIdï¼‰\n`;
                }

                result += `</div>`;

                // å°è¯•è·å– metadata
                result += `<h3>Metadata å†…å®¹ï¼š</h3>`;
                try {
                    const response = await fetch(tokenURI);
                    const metadata = await response.json();
                    result += `<div class="result-box">${JSON.stringify(metadata, null, 2)}</div>`;
                } catch (error) {
                    result += `<div class="error">âŒ æ— æ³•è·å– metadata: ${error.message}</div>`;
                }

                document.getElementById('result').innerHTML = result;

            } catch (error) {
                showResult('âŒ æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.className = type;
            resultDiv.textContent = message;
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥é’±åŒ…
        window.addEventListener('load', async () => {
            if (window.ethereum && window.ethereum.selectedAddress) {
                await connectWallet();
            }
        });
    </script>
</body>
</html>

